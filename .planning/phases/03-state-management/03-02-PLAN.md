---
phase: 03-state-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/composables/useArmyFiltering.js
  - app/composables/usePaintingStats.js
  - app/composables/useDataExport.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Army filtering works with .phase property from API responses"
    - "Painting stats lookup finds armies using .phase property"
    - "CSV export outputs phase column with correct values"
  artifacts:
    - path: "app/composables/useArmyFiltering.js"
      provides: "Army filtering by phase"
      contains: ".phase"
      must_not_contain: "a.round"
    - path: "app/composables/usePaintingStats.js"
      provides: "Painting stats with phase lookup"
      contains: ".phase"
      must_not_contain: "a.round"
    - path: "app/composables/useDataExport.js"
      provides: "CSV export with phase field"
      contains: "match.phase"
      must_not_contain: "match.round"
  key_links:
    - from: "app/composables/useArmyFiltering.js"
      to: "Army objects from API"
      via: ".phase property access"
      pattern: "filters\\.phase|a\\.phase"
    - from: "app/composables/usePaintingStats.js"
      to: "Army objects from API"
      via: ".phase property in find()"
      pattern: "a\\.phase.*===.*currentPhase"
    - from: "app/composables/useDataExport.js"
      to: "Match objects from API"
      via: ".phase property in export"
      pattern: "match\\.phase"
---

<objective>
Fix 3 composables that still use .round property access instead of .phase

Purpose: Close verification gaps from Phase 03 - these composables will cause runtime errors when users filter armies, view painting stats, or export CSV data.
Output: All 3 composables updated to use .phase property matching API response shapes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-state-management/03-VERIFICATION.md

# Source files to fix
@app/composables/useArmyFiltering.js
@app/composables/usePaintingStats.js
@app/composables/useDataExport.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix useArmyFiltering.js internal property access</name>
  <files>app/composables/useArmyFiltering.js</files>
  <action>
Update useArmyFiltering.js internal property access from .round to .phase on API objects.

**ONLY fix internal property access - do NOT rename exported functions/refs:**

1. Line 26: Change `filters.round` to `filters.phase` (filtering condition)
2. Line 37: Change sort field from `'round'` to `'phase'` (sorting key)
3. Line 48: Change `a.round` to `a.phase` (counting armies per round)

**DO NOT CHANGE:**
- Exported ref names (selectedRound stays as-is)
- Exported function names (setRoundFilter, getArmyCountForRound stay as-is)
- Return object structure

This is gap closure - we only fix runtime errors from API property shape mismatch.
The composable's public API will be renamed in Phase 4 when consumers are updated together.
  </action>
  <verify>
grep -n "a\.round\|filters\.round" app/composables/useArmyFiltering.js should return NO matches
grep -n "a\.phase\|filters\.phase" app/composables/useArmyFiltering.js should return matches
  </verify>
  <done>
useArmyFiltering.js accesses .phase property on army objects from API. Exported function names preserved for Phase 4.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix usePaintingStats.js and useDataExport.js</name>
  <files>app/composables/usePaintingStats.js, app/composables/useDataExport.js</files>
  <action>
**usePaintingStats.js:**
1. Line 43: Update JSDoc param from `currentRound` to `currentPhase`
2. Line 48: Change `a.round === currentRound` to `a.phase === currentPhase`
3. Line 126: Update JSDoc param from `currentRound` to `currentPhase`
4. Line 131: Change `a.round === currentRound` to `a.phase === currentPhase`
5. Update parameter names in function signatures from `currentRound` to `currentPhase`

**useDataExport.js:**
1. Line 151: Change `round: match.round` to `phase: match.phase`
2. Update the CSV column header from "round" to "phase" (implicit from key name)

Note: The CSV export column will now be named "phase" instead of "round" - this is the correct behavior matching the new terminology.
  </action>
  <verify>
grep -n "\.round" app/composables/usePaintingStats.js should return NO matches (except Math.round)
grep -n "\.round" app/composables/useDataExport.js should return NO matches
grep -n "a\.phase.*===.*currentPhase" app/composables/usePaintingStats.js should return 2 matches
grep -n "match\.phase" app/composables/useDataExport.js should return 1 match
  </verify>
  <done>
usePaintingStats.js finds armies by .phase property, useDataExport.js outputs phase column in CSV
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **No remaining .round property access:**
   ```bash
   grep -rn "\.round" app/composables/useArmyFiltering.js app/composables/usePaintingStats.js app/composables/useDataExport.js | grep -v "Math.round"
   ```
   Expected: No output (all .round references removed except Math.round)

2. **Phase terminology in place:**
   ```bash
   grep -n "\.phase" app/composables/useArmyFiltering.js app/composables/usePaintingStats.js app/composables/useDataExport.js
   ```
   Expected: Multiple matches showing .phase property access

3. **Build passes:**
   ```bash
   npm run build
   ```
   Expected: Build succeeds (may have warnings about unused exports if consumers not yet updated)
</verification>

<success_criteria>
- [ ] useArmyFiltering.js uses .phase property on API objects (exported names unchanged)
- [ ] usePaintingStats.js uses .phase property in army lookups
- [ ] useDataExport.js outputs phase field in CSV export
- [ ] No .round property access remains (except Math.round)
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-management/03-02-SUMMARY.md`
</output>
