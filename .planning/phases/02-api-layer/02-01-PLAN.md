---
phase: 02-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/api/armies.post.ts
  - server/api/armies.delete.ts
  - server/api/pairings/generate.post.ts
  - server/api/pairings/index.get.ts
  - server/api/pairings/manual.post.ts
autonomous: true

must_haves:
  truths:
    - "API handlers accept 'phase' in request bodies instead of 'round'"
    - "API handlers accept 'phase' in query parameters instead of 'round'"
    - "Drizzle queries use table.phase column references"
    - "Error messages reference 'phase' terminology"
  artifacts:
    - path: "server/api/armies.post.ts"
      provides: "Army creation with phase terminology"
      contains: "body.phase"
    - path: "server/api/armies.delete.ts"
      provides: "Army deletion with phase terminology"
      contains: "query.phase"
    - path: "server/api/pairings/generate.post.ts"
      provides: "Pairing generation with phase terminology"
      contains: "body.phase"
    - path: "server/api/pairings/index.get.ts"
      provides: "Pairing fetch with phase terminology"
      contains: "query.phase"
    - path: "server/api/pairings/manual.post.ts"
      provides: "Manual pairing with phase terminology"
      contains: "body.phase"
  key_links:
    - from: "server/api/armies.post.ts"
      to: "db/schema.ts"
      via: "armies.phase column reference"
      pattern: "armies\\.phase"
    - from: "server/api/pairings/generate.post.ts"
      to: "db/schema.ts"
      via: "pairings.phase column reference"
      pattern: "pairings\\.phase"
---

<objective>
Update armies and pairings API handlers to use "phase" terminology in request bodies, query parameters, and Drizzle queries.

Purpose: Complete the API layer rename for army and pairing endpoints, ensuring consistency with the database schema renamed in Phase 1.
Output: 5 API handler files using phase terminology throughout
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-layer/02-RESEARCH.md
@db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update armies API handlers</name>
  <files>
    server/api/armies.post.ts
    server/api/armies.delete.ts
  </files>
  <action>
    In server/api/armies.post.ts:
    - Change `body.round` to `body.phase` in validation check (line ~14)
    - Change error message from "round" to "phase" (line ~16-17)
    - Change `armies.round` to `armies.phase` in where clause (line ~26-27)
    - Change `round: body.round` to `phase: body.phase` in insert values (line ~58)

    In server/api/armies.delete.ts:
    - Change `query.round` to `query.phase` in query parameter parsing (line ~19)
    - Change validation message from "round" to "phase" (line ~22-25)
    - Change `armies.round` to `armies.phase` in where clause (line ~55)
  </action>
  <verify>
    Run `npx tsc --noEmit server/api/armies.post.ts server/api/armies.delete.ts` - should pass with no errors
  </verify>
  <done>
    Both armies API files use phase terminology in request parsing, Drizzle queries, and error messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pairings API handlers</name>
  <files>
    server/api/pairings/generate.post.ts
    server/api/pairings/index.get.ts
    server/api/pairings/manual.post.ts
  </files>
  <action>
    In server/api/pairings/generate.post.ts:
    - Change `round` destructuring to `phase` (line ~14)
    - Change validation from "round" to "phase" (line ~16, 19)
    - Change `pairings.round` to `pairings.phase` in where clauses (lines ~32, 41)
    - Change success message from "Round" to "Phase" (line ~55)

    In server/api/pairings/index.get.ts:
    - Change `query.round` to `query.phase` (line ~15)
    - Change `pairings.round` to `pairings.phase` in where condition (line ~30)
    - Change `round: pairings.round` to `phase: pairings.phase` in select (line ~38)

    In server/api/pairings/manual.post.ts:
    - Change `round` destructuring to `phase` (line ~13)
    - Change validation from "round" to "phase" (lines ~15, 18)
    - Change `round` to `phase` in newPairing object (line ~28)
  </action>
  <verify>
    Run `npx tsc --noEmit server/api/pairings/generate.post.ts server/api/pairings/index.get.ts server/api/pairings/manual.post.ts` - should pass with no errors
  </verify>
  <done>
    All three pairings API files use phase terminology in request parsing, Drizzle queries, and messages
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes for all 5 files
2. Grep verification: `grep -r "\.round" server/api/armies*.ts server/api/pairings/` returns no matches (except Math.round if present)
3. Grep verification: `grep -r "body\.phase\|query\.phase" server/api/armies*.ts server/api/pairings/` returns expected matches
</verification>

<success_criteria>
- All 5 API handler files compile without TypeScript errors
- No references to `body.round`, `query.round`, or `table.round` remain in these files
- Drizzle queries use `armies.phase` and `pairings.phase` column references
- Error messages use "phase" terminology
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-layer/02-01-SUMMARY.md`
</output>
