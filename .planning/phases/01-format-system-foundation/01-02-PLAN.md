---
phase: 01-format-system-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/pages/leagues/create.vue
  - server/api/leagues/create.post.ts
  - app/stores/leagues.js
autonomous: true

must_haves:
  truths:
    - "Organizer sees format options after selecting a game system in the league creation form"
    - "Format selection is required — form cannot be submitted without choosing a format"
    - "Even single-format game systems (HH) show the format step with one option"
    - "Format key is saved to the database when league is created"
    - "Changing game system clears the previously selected format"
  artifacts:
    - path: "app/pages/leagues/create.vue"
      provides: "Two-step format selection UI in league creation form"
      contains: "availableFormats"
    - path: "server/api/leagues/create.post.ts"
      provides: "Server-side format validation on league creation"
      contains: "format"
    - path: "app/stores/leagues.js"
      provides: "Store passes format to create API and includes format in league state"
      contains: "format"
  key_links:
    - from: "app/pages/leagues/create.vue"
      to: "app/data/format-registry.ts"
      via: "import getFormatsForGameSystem to populate format options"
      pattern: "getFormatsForGameSystem"
    - from: "app/pages/leagues/create.vue"
      to: "app/stores/leagues.js"
      via: "createLeague action passes format field"
      pattern: "createLeague"
    - from: "app/stores/leagues.js"
      to: "server/api/leagues/create.post.ts"
      via: "$fetch POST with format in body"
      pattern: "format"
    - from: "server/api/leagues/create.post.ts"
      to: "app/data/format-registry.ts"
      via: "validates format key exists in registry"
      pattern: "getFormatConfig"
---

<objective>
Integrate format selection into the league creation flow — form UI, store action, and API validation.

Purpose: This is the core user-facing feature of Phase 1. After this plan, organizers must select a format when creating a league, and that format is stored in the database.

Output: Updated create.vue with two-step format selection, updated create.post.ts with server-side format validation, updated leagues.js store to pass format through.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-format-system-foundation/01-RESEARCH.md
@.planning/phases/01-format-system-foundation/01-01-SUMMARY.md

@app/pages/leagues/create.vue
@server/api/leagues/create.post.ts
@app/stores/leagues.js
@app/data/format-registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add format selection UI to league creation form</name>
  <files>app/pages/leagues/create.vue</files>
  <action>
In `app/pages/leagues/create.vue`, add a format selection step that appears after the game system is selected. This implements the LOCKED decision: "Two-step: organizer picks game system first, then format options appear based on that system."

1. **Import the format registry helpers** at the top of the script section:
   ```javascript
   import { getFormatsForGameSystem } from '~/data/format-registry'
   ```

2. **Add `format` to the form reactive object** (alongside existing fields like `name`, `gameSystemId`, etc.):
   ```javascript
   format: '',  // Format key, e.g., 'ow-ptg'
   ```

3. **Create a computed `availableFormats`** that returns formats for the currently selected game system:
   ```javascript
   const availableFormats = computed(() => {
     if (!form.gameSystemId) return []
     const gameSystem = gameSystems.value.find(gs => gs.id === form.gameSystemId)
     if (!gameSystem) return []
     return getFormatsForGameSystem(gameSystem.shortName)
   })
   ```
   Note: `gameSystems` is already available via `storeToRefs` from the leagues store.

4. **Add a watcher to clear format when game system changes** (LOCKED decision: changing game system should reset format):
   ```javascript
   watch(() => form.gameSystemId, () => {
     form.format = ''
   })
   ```
   Check if there's already a watcher on `form.gameSystemId` — if so, add the format reset inside that existing watcher.

5. **Add the format selection UI** in the template, inside the "Basic Information" card section, AFTER the game system dropdown. Use clickable cards (not a dropdown) per the RESEARCH.md code example:

   - Show the section only when `form.gameSystemId` is set AND `availableFormats.length > 0`
   - Label: "League Format" with required asterisk
   - Grid of clickable cards (1 col on mobile, 2 on md+)
   - Each card shows format `name` (bold) and `description` (small, muted)
   - Selected card has purple border + bg highlight, matching the existing style patterns in the form
   - ALWAYS show the format step, even for HH which has only one format (LOCKED decision)
   - Below the cards, show helper text: "The format determines scoring rules, match recording, and available features"

6. **Update form validation** in the `validateForm()` function to require format:
   - Add check: if `!form.format` show error "Please select a league format"
   - This should be checked AFTER the game system validation

7. **Pass format to the store's createLeague action** when the form is submitted. Look at how the form data is assembled before calling `leaguesStore.createLeague()` — add `format: form.format` to the data object.
  </action>
  <verify>
Run `npm run build` (or `npx nuxi build`) to verify no compilation errors. The format selection section should render when a game system is selected.
  </verify>
  <done>League creation form shows format options after game system selection, requires format selection, and passes format to the store action. Changing game system clears format selection.</done>
</task>

<task type="auto">
  <name>Task 2: Update create API and store to handle format field</name>
  <files>server/api/leagues/create.post.ts, app/stores/leagues.js</files>
  <action>
**server/api/leagues/create.post.ts:**

1. Import the format registry at the top:
   ```typescript
   import { getFormatConfig } from '~/data/format-registry'
   ```
   Note: Server-side imports may need the path adjusted — check if `~/` resolves correctly in server context. If not, use a relative path like `../../app/data/format-registry` or check how other server files import from `app/`.

2. Add format validation after the existing required field checks:
   ```typescript
   if (!body.format) {
     throw createError({
       statusCode: 400,
       statusMessage: 'League format is required'
     })
   }
   const formatConfig = getFormatConfig(body.format)
   if (!formatConfig) {
     throw createError({
       statusCode: 400,
       statusMessage: 'Invalid league format'
     })
   }
   ```

3. Add `format` to the insert statement where the league is created:
   ```typescript
   format: body.format,
   ```
   Find the `db.insert(leagues).values({...})` call and add format alongside the other fields.

4. Make sure the response includes the format field (it should auto-include since it's in the leagues table, but verify).

**app/stores/leagues.js:**

1. Find the `createLeague` action. It receives league data and sends it to the API. Ensure it passes `format` through to the API call. Look for where the body is constructed in the `$fetch('/api/leagues/create', { method: 'POST', body: {...} })` call and add `format: leagueData.format` (or however the field is named in the incoming data).

2. After league creation succeeds, ensure the format is included in the local state update. The store likely pushes the new league into `this.myLeagues` — make sure format is preserved from the API response.

3. Verify the `switchLeague` and `fetchLeagueData` flows include format. Since these fetch from `leagues/[id].get.ts` which uses `select().from(leagues)`, the format column should be auto-included. But verify the store correctly stores it.
  </action>
  <verify>
1. Run `npm run build` to verify no compilation errors.
2. Run `npm run lint` to check for linting issues.
3. Check that the server import path for format-registry resolves correctly.
  </verify>
  <done>Create API validates format field (required + must exist in registry), inserts format into leagues table. Store passes format to API and preserves it in local state.</done>
</task>

</tasks>

<verification>
1. League creation form shows format cards after game system is selected
2. Format is required — form validation blocks submission without format
3. Changing game system clears format selection
4. Server validates format exists in registry
5. Format is stored in the leagues table
6. Store includes format in league state
</verification>

<success_criteria>
- Creating a league without format fails with validation error (client and server)
- Creating a league with invalid format key fails with 400 error
- Creating a league with valid format succeeds and stores format in DB
- Format selection appears for all game systems including HH (single option)
- Game system change resets format selection
</success_criteria>

<output>
After completion, create `.planning/phases/01-format-system-foundation/01-02-SUMMARY.md`
</output>
