---
phase: 01-format-system-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/migrate-formats.ts
autonomous: true

must_haves:
  truths:
    - "40k league has format set to '40k-matched' in the database"
    - "Old World league has format set to 'ow-ptg' in the database"
    - "OW PtG player stats are recalculated using CP scoring (Massacre=3, Major Victory=2, Minor Victory=2, Draw=1)"
    - "Painting bonus (+1 CP) is retroactively applied to OW matches where the player had fully painted army"
    - "Player wins/losses/draws/totalPoints are recalculated from scratch for OW league"
  artifacts:
    - path: "scripts/migrate-formats.ts"
      provides: "One-time migration script for existing 2 leagues"
      contains: "migrateFormats"
  key_links:
    - from: "scripts/migrate-formats.ts"
      to: "db/schema.ts"
      via: "imports schema tables for database operations"
      pattern: "import.*schema"
    - from: "scripts/migrate-formats.ts"
      to: "app/data/format-registry.ts"
      via: "references format keys for league assignment"
      pattern: "(40k-matched|ow-ptg)"
---

<objective>
Create a migration script that assigns formats to the 2 existing leagues and recalculates OW PtG player stats using CP scoring.

Purpose: The existing leagues need to be backfilled with format values, and the OW league's scoring needs to transition from VP-based to CP-based (Campaign Points derived from match results). This is a one-time script, not a user-facing feature.

Output: `scripts/migrate-formats.ts` — a runnable script that migrates both leagues.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-format-system-foundation/01-RESEARCH.md
@.planning/phases/01-format-system-foundation/01-01-SUMMARY.md

@db/schema.ts
@db/index.ts
@server/api/matches.post.ts
@app/composables/usePaintingStats.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts directory and migration script</name>
  <files>scripts/migrate-formats.ts</files>
  <action>
Create `scripts/` directory if it doesn't exist, then create `scripts/migrate-formats.ts`.

The script should:

1. **Setup:** Connect to the database using the same pattern as `db/index.ts` — import `neon` from `@neondatabase/serverless` and `drizzle` from `drizzle-orm/neon-http`. Read `DATABASE_URL` from environment. Import the schema tables needed: `leagues`, `matches`, `players`, `armies`.

2. **Discover league IDs:** Rather than hardcoding IDs, query the database to find leagues by their game system. The 40k league is the one with a game system shortName of '40k', and the OW league has shortName 'tow'. Join leagues with gameSystems to find them. If more than one league exists per game system, log a warning and skip — this script is for the known 2-league production database. Add a dry-run flag (check for `--dry-run` in process.argv) that logs what would happen without making changes.

3. **Migrate 40k league:**
   - Set `format = '40k-matched'` on the 40k league
   - Data stays as-is (already VP-based scoring)
   - Log: "Set 40k league (id: X) format to '40k-matched'"

4. **Migrate OW league — set format:**
   - Set `format = 'ow-ptg'` on the OW league
   - Log: "Set OW league (id: X) format to 'ow-ptg'"

5. **Migrate OW league — recalculate player stats from CP scoring:**

   For each match in the OW league:
   a. Get both players from the match (player1Id, player2Id)
   b. Determine the `marginOfVictory` value from the match record. The existing match schema stores match results — examine what fields are available (likely `player1Score`, `player2Score`, `result` or `marginOfVictory`)
   c. Derive CP for each player from the match result:
      - Winner with Massacre result: 3 CP
      - Winner with Major Victory: 2 CP
      - Winner with Minor Victory: 2 CP (per CONTEXT.md — Minor Victory is also 2 CP)
      - Draw: 1 CP each
      - Loser: 0 CP
   d. Check painting bonus for each player:
      - Find the player's army for the match's phase
      - Calculate painting percentage from army units data (painted models / total models across all units)
      - If 100% painted, add +1 CP bonus
      - The army data is in the `armies` table with a `units` JSON field containing per-unit painting data
   e. Track cumulative stats per player: wins, losses, draws, totalPoints (CP sum)

   IMPORTANT: Read the actual match table schema and existing match data structure before implementing. The match result fields may be named differently than expected. Check `matches` table in `db/schema.ts` for exact column names.

6. **Reset and write OW player stats:**
   - For each OW league player, update their record with the recalculated: wins, losses, draws, totalPoints (= total CP including painting bonuses)
   - Log per-player: "Player X: W/L/D = a/b/c, totalCP = N (including M painting bonuses)"

7. **Summary logging:**
   - Total matches processed
   - Total painting bonuses applied
   - Per-player final stats

8. **Error handling:**
   - Wrap in try/catch with clear error messages
   - If any step fails, log which step and the error
   - The script should NOT use transactions (if one league fails, the other should still work)

Run with: `npx tsx scripts/migrate-formats.ts` (or `npx tsx scripts/migrate-formats.ts --dry-run` for testing)
  </action>
  <verify>
1. Verify the script compiles: `npx tsx --eval "import './scripts/migrate-formats'"` (should not throw import errors)
2. Run with `--dry-run` flag to verify it can connect and find the leagues without making changes
3. If local database is available, run the full migration and verify player stats are recalculated
  </verify>
  <done>Migration script exists at scripts/migrate-formats.ts. It discovers leagues by game system, sets format keys, recalculates OW PtG stats using CP scoring with painting bonus, and outputs detailed logs. Can be run with --dry-run for safety.</done>
</task>

</tasks>

<verification>
1. scripts/migrate-formats.ts exists and compiles
2. Script discovers leagues by game system (not hardcoded IDs)
3. 40k league gets format '40k-matched'
4. OW league gets format 'ow-ptg'
5. CP derivation mapping is correct: Massacre=3, Major Victory=2, Minor Victory=2, Draw=1, Loss=0
6. Painting bonus (+1 CP) applied when army is 100% painted
7. Player stats (wins/losses/draws/totalPoints) fully recalculated
8. Dry-run mode works without modifying data
</verification>

<success_criteria>
- Script runs without errors on `npx tsx scripts/migrate-formats.ts --dry-run`
- Both leagues get correct format assignments
- OW player stats reflect CP-based scoring with painting bonuses
- Detailed logging shows what was changed and why
</success_criteria>

<output>
After completion, create `.planning/phases/01-format-system-foundation/01-03-SUMMARY.md`
</output>
