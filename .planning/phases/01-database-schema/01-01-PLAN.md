---
phase: 01-database-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/0022_rename_rounds_to_phases.sql
  - db/schema.ts
autonomous: true

must_haves:
  truths:
    - "Database table 'phases' exists (was 'rounds')"
    - "All 'round' columns renamed to 'phase' variants"
    - "Existing league data preserved after migration"
    - "Drizzle queries compile and execute without errors"
  artifacts:
    - path: "migrations/0022_rename_rounds_to_phases.sql"
      provides: "SQL migration for round->phase rename"
      contains: "RENAME"
    - path: "db/schema.ts"
      provides: "Updated Drizzle schema with phase terminology"
      contains: "phases"
  key_links:
    - from: "db/schema.ts"
      to: "database tables"
      via: "pgTable definitions must match actual table/column names"
      pattern: "pgTable\\('phases'"
---

<objective>
Rename all "round" terminology to "phase" in the database schema and migrate existing data safely.

Purpose: Eliminate terminology confusion between Warhammer battle rounds and league progression periods.
Output: Migration file that renames table/columns + updated schema.ts with new names.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-database-schema/01-RESEARCH.md
@db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and run database migration</name>
  <files>migrations/0022_rename_rounds_to_phases.sql</files>
  <action>
Generate a custom Drizzle migration using `npx drizzle-kit generate --custom --name=rename-rounds-to-phases`.

Then write the migration SQL with these exact statements (order matters):

```sql
-- Rename the rounds table to phases
ALTER TABLE "rounds" RENAME TO "phases";

-- Rename columns in leagues table
ALTER TABLE "leagues" RENAME COLUMN "currentRound" TO "currentPhase";

-- Rename columns in players table
ALTER TABLE "players" RENAME COLUMN "joined_round" TO "joined_phase";
ALTER TABLE "players" RENAME COLUMN "left_round" TO "left_phase";

-- Rename columns in pairings table
ALTER TABLE "pairings" RENAME COLUMN "round" TO "phase";

-- Rename columns in matches table
ALTER TABLE "matches" RENAME COLUMN "round" TO "phase";

-- Rename columns in armies table
ALTER TABLE "armies" RENAME COLUMN "round" TO "phase";
```

Run the migration using `npm run db:migrate`.

Important:
- Do NOT modify schema.ts yet - it must reference old names while migration runs
- The migration filename will be auto-generated by drizzle-kit (e.g., 0022_xxx.sql)
- PostgreSQL RENAME preserves all data and automatically updates FK references
  </action>
  <verify>
Run `npm run db:migrate` successfully. Verify migration ran by checking:
- `npx drizzle-kit studio` shows 'phases' table (not 'rounds')
- Or query: `SELECT table_name FROM information_schema.tables WHERE table_name = 'phases'`
  </verify>
  <done>Migration file exists in migrations/ folder and has been applied to database. Table 'phases' exists, 'rounds' does not.</done>
</task>

<task type="auto">
  <name>Task 2: Update schema.ts to match new database structure</name>
  <files>db/schema.ts</files>
  <action>
Update db/schema.ts with these changes:

1. Rename the `rounds` table export and pgTable:
```typescript
// BEFORE
export const rounds = pgTable('rounds', { ... });
// AFTER
export const phases = pgTable('phases', { ... });
```

2. In `leagues` table, rename the column:
```typescript
// BEFORE
currentRound: integer().default(1).notNull(),
// AFTER
currentPhase: integer().default(1).notNull(),
```

3. In `players` table, rename columns (keep snake_case in column names):
```typescript
// BEFORE
joinedRound: integer('joined_round').default(1).notNull(),
leftRound: integer('left_round'),
// AFTER
joinedPhase: integer('joined_phase').default(1).notNull(),
leftPhase: integer('left_phase'),
```

4. In `pairings` table:
```typescript
// BEFORE
round: integer().notNull(),
// AFTER
phase: integer().notNull(),
```

5. In `matches` table:
```typescript
// BEFORE
round: integer().notNull(),
// AFTER
phase: integer().notNull(),
```

6. In `armies` table:
```typescript
// BEFORE
round: integer().notNull(),
// AFTER
phase: integer().notNull(),
```

After updating, run `npx tsc --noEmit` to verify the schema compiles.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (schema compiles)
2. `grep -r "rounds" db/schema.ts` returns no matches
3. `grep -r "currentRound\|joinedRound\|leftRound" db/schema.ts` returns no matches
  </verify>
  <done>schema.ts uses phase terminology throughout. TypeScript compiles without errors. No references to old 'round' terminology remain in schema file.</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Database state:** `phases` table exists, `rounds` table does not
2. **Schema state:** All exports and column definitions use `phase` terminology
3. **Type safety:** `npx tsc --noEmit` passes
4. **Data preserved:** Existing league data still accessible (verify by running dev server briefly)

Run: `npm run dev` and confirm no startup errors related to schema/database mismatch.
</verification>

<success_criteria>
- [ ] Migration file exists in migrations/ and has been applied
- [ ] Database columns use `phase` naming (phase_id, phase_number, current_phase)
- [ ] Migration ran successfully without data loss on existing leagues
- [ ] All Drizzle schema definitions use `phase` terminology
- [ ] TypeScript compiles without errors
- [ ] No references to "round" remain in db/schema.ts
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-schema/01-01-SUMMARY.md`
</output>
